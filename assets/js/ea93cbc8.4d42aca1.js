"use strict";(self.webpackChunkkafka_training=self.webpackChunkkafka_training||[]).push([[675],{6166:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>d,frontMatter:()=>t,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"06-tester-resilience-deserialisation","title":"Tester la r\xe9silience \xe0 la d\xe9s\xe9rialisation JSON","description":"Apprendre \xe0 d\xe9tecter et g\xe9rer proprement les erreurs de d\xe9s\xe9rialisation dans Kafka, avec un focus p\xe9dagogique pour les d\xe9butants.","source":"@site/docs/06-deserialization-resilience.md","sourceDirName":".","slug":"/06-tester-resilience-deserialisation","permalink":"/kafka-training/docs/06-tester-resilience-deserialisation","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/06-deserialization-resilience.md","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"id":"06-tester-resilience-deserialisation","title":"Tester la r\xe9silience \xe0 la d\xe9s\xe9rialisation JSON","description":"Apprendre \xe0 d\xe9tecter et g\xe9rer proprement les erreurs de d\xe9s\xe9rialisation dans Kafka, avec un focus p\xe9dagogique pour les d\xe9butants."},"sidebar":"tutorialSidebar","previous":{"title":"Mod\xe9liser un objet m\xe9tier imbriqu\xe9 en JSON","permalink":"/kafka-training/docs/05-modeliser-objet-imbrique"},"next":{"title":"Test bout \xe0 bout - Traitement de commandes Kafka","permalink":"/kafka-training/docs/07-scenario-bout-a-bout"}}');var i=s(4848),a=s(8453);const t={id:"06-tester-resilience-deserialisation",title:"Tester la r\xe9silience \xe0 la d\xe9s\xe9rialisation JSON",description:"Apprendre \xe0 d\xe9tecter et g\xe9rer proprement les erreurs de d\xe9s\xe9rialisation dans Kafka, avec un focus p\xe9dagogique pour les d\xe9butants."},l="\ud83d\udee1\ufe0f Tester la r\xe9silience \xe0 la d\xe9s\xe9rialisation JSON",o={},c=[{value:"\ud83c\udfaf Objectif",id:"-objectif",level:2},{value:"\ud83d\udce6 Pourquoi c\u2019est important",id:"-pourquoi-cest-important",level:2},{value:"\ud83d\udd28 Ce qu\u2019on va tester",id:"-ce-quon-va-tester",level:2},{value:"\ud83e\uddea Exemple de test automatis\xe9",id:"-exemple-de-test-automatis\xe9",level:2},{value:"Cas 1 : type incorrect (fail attendu)",id:"cas-1--type-incorrect-fail-attendu",level:3},{value:"\ud83e\udde0 Pourquoi ce test passe ?",id:"-pourquoi-ce-test-passe-",level:2},{value:"Cas 2, plus subtil : champ manquant",id:"cas-2-plus-subtil--champ-manquant",level:3},{value:"\u2705 Astuce pour forcer une erreur sur champ manquant",id:"-astuce-pour-forcer-une-erreur-sur-champ-manquant",level:2},{value:"\ud83d\udcc4 M\xe9thode de test factoris\xe9e",id:"-m\xe9thode-de-test-factoris\xe9e",level:2},{value:"\ud83e\udeb5 Utilisation d\u2019un logger propre (au lieu de println)",id:"-utilisation-dun-logger-propre-au-lieu-de-println",level:2},{value:"\ud83d\udccc Ce que tu as appris ici",id:"-ce-que-tu-as-appris-ici",level:2}];function u(e){const n={br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"\ufe0f-tester-la-r\xe9silience-\xe0-la-d\xe9s\xe9rialisation-json",children:"\ud83d\udee1\ufe0f Tester la r\xe9silience \xe0 la d\xe9s\xe9rialisation JSON"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-objectif",children:"\ud83c\udfaf Objectif"}),"\n",(0,i.jsxs)(n.p,{children:["Dans cette partie, nous allons apprendre \xe0 rendre notre syst\xe8me Kafka plus robuste face \xe0 un probl\xe8me courant :",(0,i.jsx)(n.br,{}),"\n","\ud83d\udc49 ",(0,i.jsx)(n.strong,{children:"un message JSON mal form\xe9 ou inattendu"})," qui casse la d\xe9s\xe9rialisation c\xf4t\xe9 consommateur."]}),"\n",(0,i.jsx)(n.p,{children:"Nous allons voir :"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Comment ",(0,i.jsx)(n.strong,{children:"simuler des erreurs"})," de d\xe9s\xe9rialisation"]}),"\n",(0,i.jsxs)(n.li,{children:["Comment les ",(0,i.jsx)(n.strong,{children:"capturer proprement"})]}),"\n",(0,i.jsxs)(n.li,{children:["Comment ",(0,i.jsx)(n.strong,{children:"logger"})," l\u2019erreur comme en entreprise"]}),"\n",(0,i.jsxs)(n.li,{children:["Et comment ",(0,i.jsx)(n.strong,{children:"rendre nos tests stables et pr\xe9dictibles"})]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-pourquoi-cest-important",children:"\ud83d\udce6 Pourquoi c\u2019est important"}),"\n",(0,i.jsxs)(n.p,{children:["Kafka est souvent utilis\xe9 pour faire transiter des objets m\xe9tier au format JSON.",(0,i.jsx)(n.br,{}),"\n","Mais si le format change, ou si un message est corrompu, on peut avoir :"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["une ",(0,i.jsx)(n.strong,{children:"erreur silencieuse"})," (message ignor\xe9)"]}),"\n",(0,i.jsxs)(n.li,{children:["ou pire : un ",(0,i.jsx)(n.strong,{children:"crash du service"})," au moment de la d\xe9s\xe9rialisation"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["En tant que Quality Engineer, il est crucial de tester la ",(0,i.jsx)(n.strong,{children:"r\xe9silience"})," de notre application face \xe0 ces cas."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-ce-quon-va-tester",children:"\ud83d\udd28 Ce qu\u2019on va tester"}),"\n",(0,i.jsx)(n.p,{children:"Nous allons envoyer des messages Kafka contenant du JSON volontairement incorrect, par exemple :"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\ud83d\udd01 un champ mal typ\xe9 (",(0,i.jsx)(n.code,{children:'"age": "trente"'})," au lieu d\u2019un int)"]}),"\n",(0,i.jsxs)(n.li,{children:["\ud83e\udde9 une structure erron\xe9e (",(0,i.jsx)(n.code,{children:'"address": "rue de Lille"'})," au lieu d\u2019un objet)"]}),"\n",(0,i.jsxs)(n.li,{children:["\u274c un champ important manquant (",(0,i.jsx)(n.code,{children:"address"})," absent)"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Et nous allons v\xe9rifier que notre application :"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"re\xe7oit bien le message"})}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\xe9choue proprement"})," \xe0 la d\xe9s\xe9rialisation"]}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"log l\u2019erreur sans planter"})}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-exemple-de-test-automatis\xe9",children:"\ud83e\uddea Exemple de test automatis\xe9"}),"\n",(0,i.jsx)(n.p,{children:"Nous utilisons JUnit, Awaitility, et Testcontainers pour lancer un Kafka local automatiquement."}),"\n",(0,i.jsxs)(n.p,{children:["Fichier : ",(0,i.jsx)(n.code,{children:"KafkaDeserializationResilienceTest.java"})]}),"\n",(0,i.jsx)(n.h3,{id:"cas-1--type-incorrect-fail-attendu",children:"Cas 1 : type incorrect (fail attendu)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Test\nvoid testJsonDeserializationError() {\n    String json = """\n        {\n            "name": "Hugo",\n            "age": "trente",\n            "address": {\n                "street": "rue X",\n                "city": "Lille",\n                "zip": "59000"\n            }\n        }\n    """;\n    testInvalidDeserialization(json, "type incorrect : age=String");\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"-pourquoi-ce-test-passe-",children:"\ud83e\udde0 Pourquoi ce test passe ?"}),"\n",(0,i.jsx)(n.p,{children:'Le champ age est cens\xe9 \xeatre un int dans notre classe Person.\nMais ici on envoie une String.\nJackson ne peut pas convertir "trente" en int \u21d2 une exception est lev\xe9e.'}),"\n",(0,i.jsx)(n.p,{children:"Nous avons mis ce code dans un bloc try/catch dans la m\xe9thode factoris\xe9e testInvalidDeserialization(...)."}),"\n",(0,i.jsx)(n.h3,{id:"cas-2-plus-subtil--champ-manquant",children:"Cas 2, plus subtil : champ manquant"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'{ "name": "Hugo", "age": 30 }\n'})}),"\n",(0,i.jsx)(n.p,{children:"Est-ce que \xe7a casse ?"}),"\n",(0,i.jsx)(n.p,{children:"\u274c Non. Par d\xe9faut, Jackson accepte les champs manquants s\u2019ils ne sont pas strictement requis (constructeur ou validation).\nDonc si address est absent, Jackson met juste null."}),"\n",(0,i.jsx)(n.h2,{id:"-astuce-pour-forcer-une-erreur-sur-champ-manquant",children:"\u2705 Astuce pour forcer une erreur sur champ manquant"}),"\n",(0,i.jsx)(n.p,{children:"Dans notre m\xe9thode de test, nous avons ajout\xe9 une ligne sp\xe9ciale :"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"if (person.address == null) {\n    throw new IllegalArgumentException(\"Champ 'address' manquant !\");\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:'Cela permet de transformer ce "champ manquant tol\xe9r\xe9" en erreur volontaire, pour s\u2019assurer que l\u2019API attend bien un address.'}),"\n",(0,i.jsx)(n.h2,{id:"-m\xe9thode-de-test-factoris\xe9e",children:"\ud83d\udcc4 M\xe9thode de test factoris\xe9e"}),"\n",(0,i.jsx)(n.p,{children:"Signature :"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"private void testInvalidDeserialization(String json, String label)\n"})}),"\n",(0,i.jsx)(n.p,{children:"Ce qu\u2019elle fait :"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Cr\xe9e un topic Kafka avec un nom bas\xe9 sur le label"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Envoie le json cass\xe9 dans ce topic"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Lance un KafkaConsumer pour \xe9couter ce topic"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Attend 10 secondes max pour recevoir un message"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Essaie de le d\xe9s\xe9rialiser"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Si une erreur est captur\xe9e \u2192 \u2705 le test passe"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Sinon \u2192 \u274c on appelle fail(...)"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"D\xe9tail du c\u0153ur du test :"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'try {\n    Person person = mapper.readValue(record.value(), Person.class);\n\n    // Si on veut forcer l\u2019\xe9chec sur champ null\n    if (person.address == null) {\n        throw new IllegalArgumentException("Champ \'address\' manquant !");\n    }\n\n    // Sinon, la d\xe9s\xe9rialisation passe alors qu\'elle aurait d\xfb \xe9chouer\n    fail("La d\xe9s\xe9rialisation aurait d\xfb \xe9chouer !");\n} catch (Exception e) {\n    log.warn("Erreur captur\xe9e : {}", e.getMessage());\n    errorCaptured[0] = true;\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"-utilisation-dun-logger-propre-au-lieu-de-println",children:"\ud83e\udeb5 Utilisation d\u2019un logger propre (au lieu de println)"}),"\n",(0,i.jsx)(n.p,{children:"Nous avons remplac\xe9 tous les System.out.println(...) par :"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"private static final Logger log = LoggerFactory.getLogger(KafkaDeserializationResilienceTest.class);\n"})}),"\n",(0,i.jsx)(n.p,{children:"Et dans les tests :"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'log.warn("Erreur de d\xe9s\xe9rialisation captur\xe9e : {}", e.getMessage());\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u2705 Cela permet d\u2019avoir des logs lisibles, structur\xe9s, et compatibles avec une plateforme d\u2019observabilit\xe9 (ELK, Datadog\u2026)."}),"\n",(0,i.jsx)(n.h2,{id:"-ce-que-tu-as-appris-ici",children:"\ud83d\udccc Ce que tu as appris ici"}),"\n",(0,i.jsx)(n.p,{children:"\u2714 Comment envoyer un JSON cass\xe9 dans Kafka\n\u2714 Comment capturer les erreurs de d\xe9s\xe9rialisation JSON avec Jackson\n\u2714 Pourquoi certaines erreurs ne l\xe8vent pas d\u2019exception (et comment forcer une validation)\n\u2714 Comment structurer un test clair et modulaire pour tester plusieurs cas\n\u2714 Comment logger proprement comme en entreprise"})]})}function d(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>t,x:()=>l});var r=s(6540);const i={},a=r.createContext(i);function t(e){const n=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);