"use strict";(self.webpackChunkkafka_training=self.webpackChunkkafka_training||[]).push([[675],{6166:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>d,contentTitle:()=>l,default:()=>u,frontMatter:()=>t,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"deserialization-resilience","title":"Tester la r\xe9silience \xe0 la d\xe9s\xe9rialisation JJSON","description":"V\xe9rifier la robustesse de votre architecture Kafka face \xe0 des erreurs de parsing JSON","source":"@site/docs/06-deserialization-resilience.md","sourceDirName":".","slug":"/deserialization-resilience","permalink":"/kafka-training/docs/deserialization-resilience","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/06-deserialization-resilience.md","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"title":"Tester la r\xe9silience \xe0 la d\xe9s\xe9rialisation JJSON","description":"V\xe9rifier la robustesse de votre architecture Kafka face \xe0 des erreurs de parsing JSON"},"sidebar":"tutorialSidebar","previous":{"title":"Mod\xe9liser un objet m\xe9tier imbriqu\xe9 en JSON","permalink":"/kafka-training/docs/05-modeliser-objet-imbrique"}}');var i=n(4848),a=n(8453);const t={title:"Tester la r\xe9silience \xe0 la d\xe9s\xe9rialisation JJSON",description:"V\xe9rifier la robustesse de votre architecture Kafka face \xe0 des erreurs de parsing JSON"},l=void 0,d={},o=[{value:"\ud83e\udded Objectif p\xe9dagogique",id:"-objectif-p\xe9dagogique",level:2},{value:"\ud83e\uddea Simulation d\u2019une erreur de d\xe9s\xe9rialisation",id:"-simulation-dune-erreur-de-d\xe9s\xe9rialisation",level:2},{value:"\u274c Exemple de message JSON invalide",id:"-exemple-de-message-json-invalide",level:3},{value:"\u2699\ufe0f Configuration Kafka minimale (sans serializer custom)",id:"\ufe0f-configuration-kafka-minimale-sans-serializer-custom",level:2},{value:"\u2705 Ce que ce test v\xe9rifie",id:"-ce-que-ce-test-v\xe9rifie",level:2},{value:"\ud83e\udde0 Bonnes pratiques \xe0 appliquer",id:"-bonnes-pratiques-\xe0-appliquer",level:2},{value:"\ud83d\udcca Strat\xe9gies de journalisation et monitoring",id:"-strat\xe9gies-de-journalisation-et-monitoring",level:2},{value:"\ud83d\udd0e Ce qu\u2019on peut surveiller :",id:"-ce-quon-peut-surveiller-",level:2},{value:"\ud83e\uddea Approfondissements possibles avant l&#39;\xe9tape m\xe9tier",id:"-approfondissements-possibles-avant-l\xe9tape-m\xe9tier",level:3},{value:"1. \ud83e\uddf1 Tester plusieurs erreurs diff\xe9rentes",id:"1--tester-plusieurs-erreurs-diff\xe9rentes",level:2},{value:"2. \ud83e\udeb5 Logger de mani\xe8re structur\xe9e",id:"2--logger-de-mani\xe8re-structur\xe9e",level:2},{value:"3. \ud83d\udcca Compter les erreurs avec une m\xe9trique",id:"3--compter-les-erreurs-avec-une-m\xe9trique",level:2},{value:"4. \ud83e\uddea Extraire la d\xe9s\xe9rialisation dans une m\xe9thode d\xe9di\xe9e",id:"4--extraire-la-d\xe9s\xe9rialisation-dans-une-m\xe9thode-d\xe9di\xe9e",level:2},{value:"5. \ud83d\udd01 Remonter une version plus robuste",id:"5--remonter-une-version-plus-robuste",level:2}];function c(e){const r={br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.h2,{id:"-objectif-p\xe9dagogique",children:"\ud83e\udded Objectif p\xe9dagogique"}),"\n",(0,i.jsxs)(r.p,{children:["L\u2019objectif ici est de valider que notre application ",(0,i.jsx)(r.strong,{children:"ne plante pas"})," lorsqu\u2019elle re\xe7oit un message Kafka au ",(0,i.jsx)(r.strong,{children:"format JSON invalide"})," (erreur de type, champ manquant, etc.).",(0,i.jsx)(r.br,{}),"\n","Nous allons simuler un cas de d\xe9s\xe9rialisation cass\xe9e, et mettre en place une strat\xe9gie simple de ",(0,i.jsx)(r.strong,{children:"gestion d\u2019erreur robuste"}),"."]}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h2,{id:"-simulation-dune-erreur-de-d\xe9s\xe9rialisation",children:"\ud83e\uddea Simulation d\u2019une erreur de d\xe9s\xe9rialisation"}),"\n",(0,i.jsx)(r.h3,{id:"-exemple-de-message-json-invalide",children:"\u274c Exemple de message JSON invalide"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-json",children:'{\n  "name": "Hugo",\n  "age": "trente", // \u26a0\ufe0f ce champ devrait \xeatre un entier\n  "address": {\n    "street": "rue X",\n    "city": "Lille",\n    "zip": "59000"\n  }\n}\n'})}),"\n",(0,i.jsx)(r.p,{children:"Le champ age est ici une cha\xeene de caract\xe8res, alors que l\u2019objet Java Person attend un int."}),"\n",(0,i.jsx)(r.h2,{id:"\ufe0f-configuration-kafka-minimale-sans-serializer-custom",children:"\u2699\ufe0f Configuration Kafka minimale (sans serializer custom)"}),"\n",(0,i.jsx)(r.p,{children:"Nous utilisons un producteur/consommateur simple avec les classes standard :"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:"StringSerializer pour le producer"}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:"StringDeserializer c\xf4t\xe9 consumer"}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:"D\xe9s\xe9rialisation manuelle avec Jackson dans un bloc try/catch"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(r.h1,{id:"-exemple-de-test-complet",children:"\ud83d\udcc4 Exemple de test complet"}),"\n",(0,i.jsx)(r.p,{children:"Fichier : KafkaDeserializationResilienceTest.java"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-java",children:'@Test\nvoid testJsonDeserializationError() {\n    String topic = "test-json-error";\n    String badJson = """\n        { "name": "Hugo", "age": "trente", "address": { "street": "rue X", "city": "Lille", "zip": "59000" } }\n    """;\n\n    Producer<String, String> producer = new KafkaProducer<>(...);\n    producer.send(new ProducerRecord<>(topic, "key1", badJson));\n    producer.flush();\n\n    Consumer<String, String> consumer = new KafkaConsumer<>(...);\n    consumer.subscribe(List.of(topic));\n\n    Awaitility.await().untilAsserted(() -> {\n        var records = consumer.poll(Duration.ofMillis(500));\n        assertFalse(records.isEmpty());\n\n        for (var record : records) {\n            try {\n                var mapper = new ObjectMapper();\n                var person = mapper.readValue(record.value(), Person.class);\n                fail("Le test aurait d\xfb \xe9chouer !");\n            } catch (Exception e) {\n                System.out.println("\u2705 Erreur de d\xe9s\xe9rialisation captur\xe9e : " + e.getMessage());\n            }\n        }\n    });\n}\n'})}),"\n",(0,i.jsx)(r.h2,{id:"-ce-que-ce-test-v\xe9rifie",children:"\u2705 Ce que ce test v\xe9rifie"}),"\n",(0,i.jsxs)(r.p,{children:["\u2714\ufe0f Le message est bien re\xe7u par Kafka",(0,i.jsx)(r.br,{}),"\n","\u2714\ufe0f La d\xe9s\xe9rialisation \xe9choue dans le try/catch",(0,i.jsx)(r.br,{}),"\n","\u2714\ufe0f L\u2019erreur est captur\xe9e, sans provoquer de crash du test ni de NullPointerException"]}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h2,{id:"-bonnes-pratiques-\xe0-appliquer",children:"\ud83e\udde0 Bonnes pratiques \xe0 appliquer"}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"Bonne pratique"}),(0,i.jsx)(r.th,{children:"Pourquoi ?"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsxs)(r.td,{children:["\ud83d\udd01 Utiliser ",(0,i.jsx)(r.code,{children:"try/catch"})," lors de la d\xe9s\xe9rialisation"]}),(0,i.jsx)(r.td,{children:"Pour isoler les erreurs et emp\xeacher les crashs"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"\ud83e\udeb5 Logger une erreur claire avec contexte"}),(0,i.jsx)(r.td,{children:"Facilite l\u2019analyse en prod"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"\ud83e\uddea \xc9crire des tests d\xe9di\xe9s \xe0 la robustesse"}),(0,i.jsx)(r.td,{children:"Permet de d\xe9tecter les cas limites d\xe8s le CI"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsxs)(r.td,{children:["\ud83e\uddee \xc9viter les ",(0,i.jsx)(r.code,{children:"readValue(...)"})," directs sans validation"]}),(0,i.jsx)(r.td,{children:"Pour ne pas faire confiance aveugl\xe9ment au JSON entrant"})]})]})]}),"\n",(0,i.jsx)(r.h2,{id:"-strat\xe9gies-de-journalisation-et-monitoring",children:"\ud83d\udcca Strat\xe9gies de journalisation et monitoring"}),"\n",(0,i.jsx)(r.h2,{id:"-ce-quon-peut-surveiller-",children:"\ud83d\udd0e Ce qu\u2019on peut surveiller :"}),"\n",(0,i.jsx)(r.p,{children:"Nombre d\u2019erreurs de parsing par topic"}),"\n",(0,i.jsx)(r.p,{children:"Cl\xe9s associ\xe9es aux messages cass\xe9s"}),"\n",(0,i.jsx)(r.p,{children:"Horodatage + trace technique"}),"\n",(0,i.jsx)(r.p,{children:"\ud83d\udca1 Exemple de logique pro :"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-java",children:'try {\n    Person p = mapper.readValue(record.value(), Person.class);\n} catch (JsonProcessingException e) {\n    logger.warn("Erreur de parsing JSON dans Kafka : " + e.getMessage());\n    metrics.increment("kafka.deserialization.error");\n}\n'})}),"\n",(0,i.jsx)(r.p,{children:"\ud83e\uddea Commande pour relancer le test"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:"mvn test -Dtest=KafkaDeserializationResilienceTest\n"})}),"\n",(0,i.jsx)(r.p,{children:"Tu dois voir :"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:'\u2705 Erreur de d\xe9s\xe9rialisation captur\xe9e : Cannot deserialize value of type `int` from String "trente"\n'})}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.p,{children:"\ud83d\udccc Conclusion"}),"\n",(0,i.jsx)(r.p,{children:"Tu viens d\u2019apprendre \xe0 :"}),"\n",(0,i.jsx)(r.p,{children:"Simuler des erreurs r\xe9alistes dans un flux Kafka"}),"\n",(0,i.jsx)(r.p,{children:"Capturer ces erreurs de mani\xe8re propre"}),"\n",(0,i.jsx)(r.p,{children:"Mettre en place une base de monitoring r\xe9silient"}),"\n",(0,i.jsx)(r.p,{children:"Appliquer des bonnes pratiques compatibles production"}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h3,{id:"-approfondissements-possibles-avant-l\xe9tape-m\xe9tier",children:"\ud83e\uddea Approfondissements possibles avant l'\xe9tape m\xe9tier"}),"\n",(0,i.jsx)(r.h2,{id:"1--tester-plusieurs-erreurs-diff\xe9rentes",children:"1. \ud83e\uddf1 Tester plusieurs erreurs diff\xe9rentes"}),"\n",(0,i.jsx)(r.p,{children:"Exemples :"}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"Cas"}),(0,i.jsx)(r.th,{children:"Exemple"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"\ud83e\udde9 Type incorrect"}),(0,i.jsxs)(r.td,{children:[(0,i.jsx)(r.code,{children:'"age": "trente"'})," au lieu d\u2019un int"]})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"\u274c Champ manquant"}),(0,i.jsxs)(r.td,{children:["Pas de ",(0,i.jsx)(r.code,{children:"address"})," du tout"]})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"\ud83e\udde8 Structure incorrecte"}),(0,i.jsxs)(r.td,{children:[(0,i.jsx)(r.code,{children:'"address": "rue x"'})," au lieu d\u2019un objet"]})]})]})]}),"\n",(0,i.jsx)(r.p,{children:"\ud83c\udfaf But : valider que chaque cas est captur\xe9 proprement et que tu peux les diff\xe9rencier dans les logs."}),"\n",(0,i.jsx)(r.h1,{id:"-test-d\xe9di\xe9",children:"\ud83d\udcc4 Test d\xe9di\xe9"}),"\n",(0,i.jsx)(r.p,{children:"On ajoute une m\xe9thode par erreur dans KafkaDeserializationResilienceTest.java :"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-java",children:'@Test\nvoid testDeserializationFailsOnMissingField() {\n    String badJson = """{ "name": "Hugo", "age": 30 }"""; // pas de \'address\'\n\n    testInvalidDeserialization(badJson, "champ manquant");\n}\n\n@Test\nvoid testDeserializationFailsOnInvalidAddressStructure() {\n    String badJson = """{ "name": "Hugo", "age": 30, "address": "invalid" }"""; // address en string\n\n    testInvalidDeserialization(badJson, "structure invalide");\n}\n\n\nprivate void testInvalidDeserialization(String json, String label) {\n    String topic = "test-json-error-" + label.replace(" ", "-");\n    Producer<String, String> producer = new KafkaProducer<>(...);\n    producer.send(new ProducerRecord<>(topic, "key", json));\n    producer.flush();\n\n    Consumer<String, String> consumer = new KafkaConsumer<>(...);\n    consumer.subscribe(List.of(topic));\n\n    Awaitility.await().untilAsserted(() -> {\n        var records = consumer.poll(Duration.ofMillis(500));\n        assertFalse(records.isEmpty());\n\n        for (var record : records) {\n            try {\n                var mapper = new ObjectMapper();\n                mapper.readValue(record.value(), Person.class);\n                fail("La d\xe9s\xe9rialisation aurait d\xfb \xe9chouer pour : " + label);\n            } catch (Exception e) {\n                System.out.println("\u2705 Erreur attendue (" + label + ") : " + e.getMessage());\n            }\n        }\n    });\n}\n'})}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h2,{id:"2--logger-de-mani\xe8re-structur\xe9e",children:"2. \ud83e\udeb5 Logger de mani\xe8re structur\xe9e"}),"\n",(0,i.jsx)(r.p,{children:"Utiliser SLF4J + Logback au lieu de System.out"}),"\n",(0,i.jsx)(r.p,{children:"Exemple :"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-java",children:'private static final Logger log = LoggerFactory.getLogger(getClass());\nlog.warn("Erreur JSON pour key {}: {}", record.key(), e.getMessage());\n'})}),"\n",(0,i.jsx)(r.p,{children:"\ud83c\udfaf But : pratique attendue en entreprise pour tracer les erreurs Kafka dans un ELK / Datadog / Sentry."}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h2,{id:"3--compter-les-erreurs-avec-une-m\xe9trique",children:"3. \ud83d\udcca Compter les erreurs avec une m\xe9trique"}),"\n",(0,i.jsx)(r.p,{children:"Simuler un compteur (int parseFailures = 0)"}),"\n",(0,i.jsx)(r.p,{children:"Ou utiliser Micrometer si tu veux l\u2019int\xe9grer plus tard \xe0 Prometheus"}),"\n",(0,i.jsx)(r.p,{children:"\ud83c\udfaf But : pr\xe9parer un hook vers du monitoring r\xe9el"}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h2,{id:"4--extraire-la-d\xe9s\xe9rialisation-dans-une-m\xe9thode-d\xe9di\xe9e",children:"4. \ud83e\uddea Extraire la d\xe9s\xe9rialisation dans une m\xe9thode d\xe9di\xe9e"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-java",children:'public Optional<Person> safeParse(String json) {\n  try {\n    return Optional.of(mapper.readValue(json, Person.class));\n  } catch (...) {\n    log.warn("Erreur de parsing", e);\n    return Optional.empty();\n  }\n}\n'})}),"\n",(0,i.jsx)(r.p,{children:"\ud83c\udfaf But : r\xe9utilisabilit\xe9 + testabilit\xe9 unitaire"}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h2,{id:"5--remonter-une-version-plus-robuste",children:"5. \ud83d\udd01 Remonter une version plus robuste"}),"\n",(0,i.jsx)(r.p,{children:"Utiliser un schema registry avec Avro ou JSON Schema"}),"\n",(0,i.jsx)(r.p,{children:"Ou valider manuellement ton JSON avec une lib comme Everit ou Justify"}),"\n",(0,i.jsx)(r.p,{children:"\ud83c\udfaf But : poser la base pour ton r\xf4le de r\xe9f\xe9rente qualit\xe9 Kafka"})]})}function u(e={}){const{wrapper:r}={...(0,a.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>t,x:()=>l});var s=n(6540);const i={},a=s.createContext(i);function t(e){const r=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function l(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),s.createElement(a.Provider,{value:r},e.children)}}}]);